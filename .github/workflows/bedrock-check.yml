name: Bedrock server -> Discord webhook

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-servers:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq + curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Query servers and post to Discord
        shell: bash
        run: |
          set -u

          FILE="servers.txt"
          if [ ! -f "$FILE" ]; then
            echo "Error: $FILE not found in repo root."
            exit 1
          fi

          while IFS= read -r rawline || [ -n "$rawline" ]; do
            line="${rawline%%#*}"
            line="$(echo -n "$line" | tr -d '\r' | xargs || true)"
            [ -z "$line" ] && continue

            host="$line"
            port="19132"
            if [[ "$line" == *":"* ]]; then
              host="${line%%:*}"
              port="${line##*:}"
            fi

            api_url="https://api.mcsrvstat.us/bedrock/2/${host}:${port}"
            echo "Querying $api_url"

            resp="$(curl -sS --max-time 15 "$api_url")" || {
              echo "Warning: failed to fetch $api_url"
              continue
            }

            motd="$(echo "$resp" | jq -r '
              if (.motd? and (.motd.clean? and (.motd.clean | type) == "array")) then
                (.motd.clean | join(" "))
              elif (.motd? and (.motd.clean? and (.motd.clean | type) == "string")) then
                .motd.clean
              elif (.motd? and .motd.raw?) then
                .motd.raw
              elif .hostname? then
                .hostname
              else
                empty
              end // "Unknown"
            ')

            # Decode HTML entities safely (no heredoc)
            motd="$(printf '%s' "$motd" | python3 -c 'import sys,html; print(html.unescape(sys.stdin.read()))')"

            ip="$(echo "$resp" | jq -r --arg default "$host" '.ip // $default')"
            port_out="$(echo "$resp" | jq -r --arg default "$port" '.port // $default')"
            players_online="$(echo "$resp" | jq -r '.players.online // 0')"
            players_max="$(echo "$resp" | jq -r '.players.max // 0')"

            epoch="$(date +%s)"
            discord_time_tag="<t:${epoch}:t>"

            message="Server name: ${motd}\nAddress: ${ip}\nPort: ${port_out}\nPlayer Count (as of ${discord_time_tag}): ${players_online}/${players_max}"

            payload="$(jq -nc --arg c "$message" '{content: $c}')"

            http_code="$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Content-Type: application/json" \
              -d "$payload" \
              "$DISCORD_WEBHOOK" || echo "000")"

            if [ "$http_code" != "204" ] && [ "$http_code" != "200" ]; then
              echo "Warning: webhook POST returned HTTP $http_code for server $host:$port_out"
            else
              echo "Posted server $host:$port_out -> Discord (http $http_code)"
            fi

            sleep 1
          done < "$FILE"
