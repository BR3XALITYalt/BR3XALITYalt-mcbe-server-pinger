name: Bedrock server -> Discord webhook

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-servers:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Query servers and post
        run: |
          set -euo pipefail

          while IFS= read -r rawline || [ -n "$rawline" ]; do
            line="${rawline%%#*}"
            line="$(echo -n "$line" | tr -d '\r' | xargs || true)"
            [ -z "$line" ] && continue

            host="$line"
            port="19132"
            if [[ "$line" == *:* ]]; then
              host="${line%%:*}"
              port="${line##*:}"
            fi

            api="https://api.mcsrvstat.us/bedrock/2/${host}:${port}"
            resp="$(curl -sS --max-time 15 "$api")" || continue

            motd="$(echo "$resp" | jq -r '
              if (.motd? and (.motd.clean? and (.motd.clean | type) == "array")) then
                (.motd.clean | join(" "))
              elif (.motd? and (.motd.clean? and (.motd.clean | type) == "string")) then
                .motd.clean
              elif (.motd? and .motd.raw?) then
                .motd.raw
              elif .hostname? then
                .hostname
              else
                "Unknown"
              end
            ')"

            # Decode common HTML entities safely
            motd="${motd//&#039;/' }"
            motd="${motd//&amp;/&}"
            motd="${motd//&lt;/<}"
            motd="${motd//&gt;/>}"

            ip="$(echo "$resp" | jq -r --arg d "$host" '.ip // $d')"
            port_out="$(echo "$resp" | jq -r --arg d "$port" '.port // $d')"
            online="$(echo "$resp" | jq -r '.players.online // 0')"
            max="$(echo "$resp" | jq -r '.players.max // 0')"

            epoch="$(date +%s)"

            printf -v message "%s\n%s\n%s\n%s\n" \
              "Server name: ${motd}" \
              "Address: ${ip}" \
              "Port: ${port_out}" \
              "Player Count (as of <t:${epoch}:t>): ${online}/${max}"

            payload="$(jq -nc --arg content "$message" '{content:$content}')"

            curl -sS -H "Content-Type: application/json" \
                 -d "$payload" \
                 "$DISCORD_WEBHOOK" >/dev/null

            sleep 1
          done < servers.txt
