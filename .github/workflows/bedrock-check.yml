name: Bedrock server -> Discord webhook

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-servers:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq + curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Query servers and post to Discord
        shell: bash
        run: |
          set -u

          FILE="servers.txt"
          if [ ! -f "$FILE" ]; then
            echo "Error: $FILE not found in repo root."
            exit 1
          fi

          while IFS= read -r rawline || [ -n "$rawline" ]; do
            line="${rawline%%#*}"
            line="$(echo -n "$line" | tr -d '\r' | xargs || true)"
            [ -z "$line" ] && continue

            host="$line"
            port="19132"
            case "$line" in
              *:*)
                host="${line%%:*}"
                port="${line##*:}"
                ;;
            esac

            api_url="https://api.mcsrvstat.us/bedrock/2/${host}:${port}"
            echo "Querying $api_url"

            resp="$(curl -sS --max-time 30 "$api_url")" || continue

            # Simplified jq filter (single line to avoid YAML/bash parsing issues)
            motd="$(echo "$resp" | jq -r '(.motd.clean // .motd.raw // .hostname // "Unknown") | if type=="array" then join(" ") else . end')"

            # Minimal HTML entity fix for apostrophes
            motd="$(printf '%s' "$motd" | sed "s/&#039;/'/g")"

            ip="$(echo "$resp" | jq -r --arg default "$host" '.ip // $default')"
            port_out="$(echo "$resp" | jq -r --arg default "$port" '.port // $default')"
            players_online="$(echo "$resp" | jq -r '.players.online // 0')"
            players_max="$(echo "$resp" | jq -r '.players.max // 0')"

            epoch="$(date +%s)"
            discord_time_tag="<t:${epoch}:t>"

            payload=$(
            jq -nc \
            --arg name "$motd" \
            --arg ip "$ip" \
            --arg port "$port_out" \
            --arg time "$discord_time_tag" \
            --arg players "${players_online}/${players_max}" \
            '{content: "Server name: \($name)\nAddress: \($ip)\nPort: \($port)\nPlayer Count (as of \($time)): \($players)"}'
            )


            curl -sS -H "Content-Type: application/json" \
              -d "$payload" \
              "$DISCORD_WEBHOOK" >/dev/null

            sleep 1
          done < "$FILE"
